stages:
  - test
  - perf

cypress_tests:
  stage: test
  image: cypress/base:22.19.0
  script:
    - npm ci
    - echo "DB_CONNECT=mongodb+srv://$MONGODB_ACCESS$MONGODB_HOST?retryWrites=true&w=majority&appName=Cluster0" > .env
    - npm run test:api

JMeter_perf:
  stage: perf
  image: alpine/jmeter:latest
  script:
    - npm ci
    - echo "DB_CONNECT=mongodb+srv://$MONGODB_ACCESS$MONGODB_HOST?retryWrites=true&w=majority&appName=Cluster0" > .env
    - jmeter -n -t tests/mytest.jmx -l out.jtl -e -o out -JbaseUrl=http://localhost:3000
  artifacts:
    when: always
    paths:
      - out